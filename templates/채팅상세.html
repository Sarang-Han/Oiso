<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>채팅상세</title>
    <link rel="stylesheet" type="text/css" href='../static/css/채팅상세.css'>
</head>
<body>
    <div class="content">
        <header>
            <button onclick="goBack()"><img src="../static/image/back.png" 
                alt="이전" style="width: 20px;"></button>
            <h3>채팅상세</h3>
        </header>
    
        <div id="chatBox">
            <!-- 채팅 메시지가 있는 경우 -->
            {% if chat_messages %}
                {% for chat_key, chat_message in chat_messages.items() %}
                    <p>{{ chat_message['Id'] }}: {{ chat_message['msg'] }}</p>
                {% endfor %}
            <!-- 채팅 메시지가 없는 경우 -->
            {% else %}
                <p>채팅 내역이 없습니다.</p>
            {% endif %}
        </div>        
        
        
        <div>
            <input type="text" id="messageInput" placeholder="메시지 입력">
            <button id="sendButton" onclick="sendMessage('{{ product_key }}')">전송</button>
        </div>

</div>

    <nav>
        <a href="/메인화면"><img src="../static/image/home.png" width="20px"><br>메인 홈</a>
        <a href="/리뷰전체보기"><img src="../static/image/write.png" width="20px"><br>전체 리뷰</a>
        <a href="/상품등록"><img src="../static/image/add.png" width="20px"><br>상품 등록</a>
        <a href="/채팅목록" class="nav-active"><img src="../static/image/chat.png" width="20px"><br>채팅 보기</a>
        <a href="/마이페이지1"><img src="../static/image/user.png" width="20px"><br>My</a>
    </nav>

</div>
<script>
    function goBack() {
        window.history.back();
    }
    
    function sendMessage(productKey) {
        var messageInput = document.getElementById("messageInput");
        var message = messageInput.value.trim();
        
        if (message !== "") {
            // AJAX를 사용하여 서버로 메시지 전송
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/send_message", true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        // 성공적으로 메시지를 전송한 경우, 화면에 메시지 추가
                        var chatBox = document.getElementById("chatBox");
                        var newMessage = document.createElement("p");
                        newMessage.textContent = "{{ user_id }}: " + message;
                        chatBox.appendChild(newMessage);
                        
                        // 메시지 전송 후 입력창 초기화
                        messageInput.value = "";
                    }
                }
            };
            
            var data = JSON.stringify({
                "product_key": productKey,
                "participant_id": "{{ user_id }}",
                "message": message,
                "timestamp": new Date().toISOString()
            });
            
            xhr.send(data);
        }
    }
    
    
</script>
</body>
</html>